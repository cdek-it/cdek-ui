name: Auto Milestone & Label Management

on:
  push:
    branches:
      - 'release/v*'
  pull_request:
    types: [opened, synchronize, reopened, edited]
  release:
    types: [published]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  manage-milestones-and-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Auto milestone and label management
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;

            // Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð°: Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· ÑÑ‚Ñ€Ð¾ÐºÐ¸ (v1.2.3 â†’ 1.2.3)
            function extractVersion(str) {
              const match = str.match(/^v?(\d+\.\d+(\.\d+)?)$/);
              return match ? match[1] : null;
            }

            // Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð°: ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ð²ÐµÑ€ÑÐ¸Ð¸ (1.10 > 1.2)
            function compareVersions(a, b) {
              const partsA = a.split('.').map(Number);
              const partsB = b.split('.').map(Number);
              for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                const pA = partsA[i] || 0;
                const pB = partsB[i] || 0;
                if (pA !== pB) return pA - pB;
              }
              return 0;
            }

            // 1. CREATE LABEL ÐŸÐ Ð˜ ÐŸÐ£Ð¨Ð• Ð’ release/v*
            if (context.eventName === 'push') {
              const ref = context.ref; // refs/heads/release/v1.2.3
              if (!ref.startsWith('refs/heads/release/v')) return;

              const version = extractVersion(ref.replace('refs/heads/release/', ''));
              if (!version) return;

              const labelName = `release:v${version}`;
              console.log(`ðŸ·ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ label "${labelName}"`);

              try {
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ label
                const existingLabels = await github.rest.issues.listLabelsForRepo({ owner: org, repo });
                if (!existingLabels.data.some(l => l.name === labelName)) {
                  await github.rest.issues.createLabel({
                    owner: org,
                    repo,
                    name: labelName,
                    color: '0e8a16',
                    description: `ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð° v${version}`
                  });
                  console.log(`âœ… Label "${labelName}" ÑÐ¾Ð·Ð´Ð°Ð½.`);
                } else {
                  console.log(`â„¹ï¸ Label "${labelName}" ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚.`);
                }
              } catch (err) {
                console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ Ð»ÐµÐ¹Ð±Ð»Ð¾Ð¼: ${err.message}`);
              }
              return;
            }

            // 2. ÐŸÐ Ð˜Ð¡Ð’ÐžÐ˜Ð¢Ð¬ LABEL Ðš PR, Ð¡Ð’Ð¯Ð—ÐÐÐÐ«Ðœ Ð¡ release/v*
            if (context.eventName === 'pull_request') {
              const pr = context.payload.pull_request;
              const headRef = pr.head.ref;   // source Ð²ÐµÑ‚ÐºÐ°
              const baseRef = pr.base.ref;   // target Ð²ÐµÑ‚ÐºÐ°

              // Ð˜Ñ‰ÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ release/v* ÑÑ€ÐµÐ´Ð¸ source/target
              const releaseBranchPattern = /^release\/v(\d+\.\d+(\.\d+)?)$/;
              const headMatch = headRef.match(releaseBranchPattern);
              const baseMatch = baseRef.match(releaseBranchPattern);


              if (!headMatch && !baseMatch) {
                console.log(`â„¹ï¸ PR #${pr.number} Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½ Ñ release/v*. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼.`);
                return;
              }

              const version = (headMatch || baseMatch)[1];
              const labelName = `release:v${version}`;


              console.log(`ðŸ”– Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ label "${labelName}" Ðº PR #${pr.number}`);

              try {
                const currentLabels = pr.labels.map(l => l.name);
                if (!currentLabels.includes(labelName)) {
                  await github.rest.issues.addLabels({
                    owner: org,
                    repo,
                    issue_number: pr.number,
                    labels: [labelName]
                  });
                  console.log(`âœ… Ð›ÐµÐ¹Ð±Ð» "${labelName}" Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ðº PR #${pr.number}`);
                } else {
                  console.log(`â„¹ï¸ Ð›ÐµÐ¹Ð±Ð» "${labelName}" ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ñƒ PR #${pr.number}`);
                }
              } catch (err) {
                console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð»ÐµÐ¹Ð±Ð»Ð°: ${err.message}`);
              }
              return;
            }

            // 3. ÐŸÐžÐ¡Ð›Ð• ÐŸÐ£Ð‘Ð›Ð˜ÐšÐÐ¦Ð˜Ð˜ Ð Ð•Ð›Ð˜Ð—Ð: Ð·Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Milestone Ð¸ Ð¿ÐµÑ€ÐµÐ½ÐµÑÑ‚Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸
            if (context.eventName === 'release' && context.payload.action === 'published') {
              const tag = context.payload.release.tag_name;
              if (!tag.startsWith('v')) return;

              const version = extractVersion(tag);
              if (!version) return;

              const milestoneTitle = `v${version}`; // â† Ð’Ð°Ð¶Ð½Ð¾: ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÐµÐ¼!
              console.log(`ðŸš€ ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð° "${tag}", Ð¸Ñ‰ÐµÐ¼ milestone "${milestoneTitle}"`);

              try {
                // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Milestone
                const milestones = await github.rest.issues.listMilestones({ owner: org, repo, state: 'all' });

                // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Milestone
                const current = milestones.data.find(m => m.title === milestoneTitle);
                if (!current) {
                  console.log(`âš ï¸ Milestone "${milestoneTitle}" Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.`);
                  return;
                }

                // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Milestone Ð¿Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¸ (ÑÐµÐ¼Ð°Ð½Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
                const sortedMilestones = milestones.data
                  .filter(m => m.title.match(/^v\d+\.\d+(\.\d+)?$/))
                  .sort((a, b) => compareVersions(
                    extractVersion(a.title),
                    extractVersion(b.title)
                  ));

                // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Milestone
                const nextIndex = sortedMilestones.findIndex(m => m.title === milestoneTitle) + 1;
                const nextMilestone = nextIndex < sortedMilestones.length ? sortedMilestones[nextIndex] : null;


                console.log(`ðŸ“¦ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ milestone: ${milestoneTitle}`);
                console.log(`âž¡ï¸ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ milestone: ${nextMilestone ? nextMilestone.title : 'âŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'}`);


                // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Milestone
                const openIssues = await github.rest.issues.listForRepo({
                  owner: org,
                  repo,
                  milestone: current.number,
                  state: 'open',
                  per_page: 100
                });

                console.log(`ðŸ” ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ${openIssues.data.length} Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡`);
