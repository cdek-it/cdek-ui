name: Auto Milestone & Label Management

on:
  push:
    branches:
      - 'release/v*'
  pull_request:
    types: [opened, synchronize, reopened, edited]
  release:
    types: [published]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  manage-milestones-and-labels:
    runs-on: ubuntu-latest


    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Auto milestone and label management
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;

            // –£—Ç–∏–ª–∏—Ç–∞: –∏–∑–≤–ª–µ—á—å –≤–µ—Ä—Å–∏—é –∏–∑ —Å—Ç—Ä–æ–∫–∏ (v1.2.3 ‚Üí 1.2.3)
            function extractVersion(str) {
              const match = str.match(/^v?(\d+\.\d+(\.\d+)?)$/);
              return match ? match[1] : null;
            }

            // –£—Ç–∏–ª–∏—Ç–∞: —Å—Ä–∞–≤–Ω–∏—Ç—å –≤–µ—Ä—Å–∏–∏ (1.10 > 1.2)
            function compareVersions(a, b) {
              const partsA = a.split('.').map(Number);
              const partsB = b.split('.').map(Number);
              for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                const pA = partsA[i] || 0;
                const pB = partsB[i] || 0;
                if (pA !== pB) return pA - pB;
              }
              return 0;
            }

            // 1. CREATE LABEL –ü–†–ò –ü–£–®–ï –í release/v*
            if (context.eventName === 'push') {
              const ref = context.ref; // refs/heads/release/v1.2.3
              if (!ref.startsWith('refs/heads/release/v')) return;


              const version = extractVersion(ref.replace('refs/heads/release/', ''));
              if (!version) {
                console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –≤–µ—Ä—Å–∏—é –∏–∑ –≤–µ—Ç–∫–∏: ${ref}`);
                return;
              }

              const labelName = `release:v${version}`;
              console.log(`üè∑Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º label "${labelName}"`);


              try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ label
                const existingLabels = await github.rest.issues.listLabelsForRepo({ owner: org, repo });
                if (!existingLabels.data.some(l => l.name === labelName)) {
                  await github.rest.issues.createLabel({
                    owner: org,
                    repo,
                    name: labelName,
                    color: '0e8a16',
                    description: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è —Ä–µ–ª–∏–∑–∞ v${version}`
                  });
                  console.log(`‚úÖ Label "${labelName}" —Å–æ–∑–¥–∞–Ω.`);
                } else {
                  console.log(`‚ÑπÔ∏è Label "${labelName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.`);
                }
              } catch (err) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ª–µ–π–±–ª–æ–º: ${err.message}`);
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º workflow ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
              }
              return;
            }

            // 2. –ü–†–ò–°–í–û–ò–¢–¨ LABEL –ö PR, –°–í–Ø–ó–ê–ù–ù–´–ú –° release/v*
            if (context.eventName === 'pull_request') {
              const pr = context.payload.pull_request;
              const headRef = pr.head.ref;   // source –≤–µ—Ç–∫–∞
              const baseRef = pr.base.ref;   // target –≤–µ—Ç–∫–∞


              // –ò—â–µ–º –≤–µ—Ç–∫—É release/v* —Å—Ä–µ–¥–∏ source/target
              const releaseBranchPattern = /^release\/v(\d+\.\d+(\.\d+)?)$/;
              const headMatch = headRef.match(releaseBranchPattern);
              const baseMatch = baseRef.match(releaseBranchPattern);


              if (!headMatch && !baseMatch) {
                console.log(`‚ÑπÔ∏è PR #${pr.number} –Ω–µ —Å–≤—è–∑–∞–Ω —Å release/v*. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
                return;
              }

              const version = (headMatch || baseMatch)[1];
              const labelName = `release:v${version}`;


              console.log(`üîñ –î–æ–±–∞–≤–ª—è–µ–º label "${labelName}" –∫ PR #${pr.number}`);


              try {
                const currentLabels = pr.labels.map(l => l.name);
                if (!currentLabels.includes(labelName)) {
                  await github.rest.issues.addLabels({
                    owner: org,
                    repo,
                    issue_number: pr.number,
                    labels: [labelName]
                  });
                  console.log(`‚úÖ –õ–µ–π–±–ª "${labelName}" –¥–æ–±–∞–≤–ª–µ–Ω –∫ PR #${pr.number}`);
                } else {
                  console.log(`‚ÑπÔ∏è –õ–µ–π–±–ª "${labelName}" —É–∂–µ –µ—Å—Ç—å —É PR #${pr.number}`);
                }
              } catch (err) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ª–µ–π–±–ª–∞ –∫ PR #${pr.number}: ${err.message}`);
              }
              return;
            }

            // 3. –ü–û–°–õ–ï –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –†–ï–õ–ò–ó–ê: –∑–∞–∫—Ä—ã—Ç—å Milestone –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—á–∏
            if (context.eventName === 'release' && context.payload.action === 'published') {
              const tag = context.payload.release.tag_name;
              if (!tag.startsWith('v')) {
                console.log(`‚ö†Ô∏è –¢–µ–≥ —Ä–µ–ª–∏–∑–∞ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'v': ${tag}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
                return;
              }

              const version = extractVersion(tag);
              if (!version) {
                console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –≤–µ—Ä—Å–∏—é –∏–∑ —Ç–µ–≥–∞: ${tag}`);
                return;
              }

              const milestoneTitle = `v${version}`; // –§–æ—Ä–º–∞—Ç: v1.2.3
              console.log(`üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞ "${tag}", –∏—â–µ–º milestone "${milestoneTitle}"`);


              try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ Milestone
                const milestones = await github.rest.issues.listMilestones({ owner: org, repo, state: 'all' });

                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π Milestone
                const current = milestones.data.find(m => m.title === milestoneTitle);
                if (!current) {
                  console.log(`‚ö†Ô∏è Milestone "${milestoneTitle}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                  return;
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º Milestone –ø–æ –≤–µ—Ä—Å–∏–∏
                const sortedMilestones = milestones.data
                  .filter(m => m.title.match(/^v\d+\.\d+(\.\d+)?$/))
                  .sort((a, b) => compareVersions(
                    extractVersion(a.title),
                    extractVersion(b.title)
                  ));

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π Milestone
                const nextIndex = sortedMilestones.findIndex(m => m.title === milestoneTitle) + 1;
                const nextMilestone = nextIndex < sortedMilestones.length ? sortedMilestones[nextIndex] : null;


                console.log(`üì¶ –¢–µ–∫—É—â–∏–π milestone: ${milestoneTitle}`);
                console.log(`‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π milestone: ${nextMilestone ? nextMilestone.title : '‚ùå –Ω–µ –Ω–∞–π–¥–µ–Ω'}`);


                // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏ —Ç–µ–∫—É—â–µ–≥–æ Milestone
                const openIssues = await github.rest.issues.listForRepo({
                  owner: org,
                  repo,
                  milestone: current.number,
                  state: 'open',
                  per_page: 100
                });

                console.log(`üîç –ù–∞–π–¥–µ–Ω–æ ${openIssues.data.length} –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á`);


                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π Milestone
                if (nextMilestone && openIssues.data.length > 0) {
                  for (const issue of openIssues.data) {
                    try {
                      await github.rest.issues.update({
                        owner: org,
                        repo,
                        issue_number: issue.number,
                        milestone: nextMilestone.number
                      });
                      console.log(`‚û°Ô∏è –ó–∞–¥–∞—á–∞ #${issue.number} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ ${nextMilestone.title}`);
                    } catch (err) {
                      console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–¥–∞—á–∏ #${issue.number}: ${err.message}`);
                    }
                  }
                }

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π Milestone
                await github.rest.issues
