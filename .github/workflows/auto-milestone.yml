name: Auto Milestone & Label Management

on:
  push:
    branches:
      - 'release/v*'
  pull_request:
    types: [opened, synchronize, reopened, edited]
  release:
    types: [published]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  manage-milestones-and-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Auto milestone and label management
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;

            function extractVersion(str) {
              const match = str.match(/^v?(\d+\.\d+(\.\d+)?)$/);
              return match ? match[1] : null;
            }

            function compareVersions(a, b) {
              const A = a.split('.').map(Number);
              const B = b.split('.').map(Number);
              for (let i = 0; i < Math.max(A.length, B.length); i++) {
                const x = A[i] || 0;
                const y = B[i] || 0;
                if (x !== y) return x - y;
              }
              return 0;
            }

            // 1) CREATE LABEL WHEN PUSHING release/v*
            if (context.eventName === 'push') {
              const ref = context.ref;
              if (!ref.startsWith('refs/heads/release/v')) return;

              const version = extractVersion(ref.replace('refs/heads/release/', ''));
              if (!version) return;

              const labelName = `release:v${version}`;
              console.log(`Checking label ${labelName}`);

              const labels = await github.rest.issues.listLabelsForRepo({ owner: org, repo });
              if (!labels.data.some(l => l.name === labelName)) {
                await github.rest.issues.createLabel({
                  owner: org,
                  repo,
                  name: labelName,
                  color: '0e8a16',
                  description: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è —Ä–µ–ª–∏–∑–∞ v${version}`
                });
                console.log(`‚úÖ Label ${labelName} —Å–æ–∑–¥–∞–Ω`);
              }
              return;
            }

            // 2) APPLY LABEL TO PR RELATED TO release/v*
            if (context.eventName === 'pull_request') {
              const pr = context.payload.pull_request;
              const branchList = [pr.head.ref, pr.base.ref];

              const match = branchList
                .map(b => b.match(/^release\/v(\d+\.\d+(\.\d+)?)$/))
                .find(Boolean);

              if (!match) return;

              const version = match[1];
              const labelName = `release:v${version}`;

              if (!pr.labels.some(l => l.name === labelName)) {
                await github.rest.issues.addLabels({
                  owner: org,
                  repo,
                  issue_number: pr.number,
                  labels: [labelName]
                });
                console.log(`‚úÖ Added label ${labelName} to PR #${pr.number}`);
              }
              return;
            }

            // 3) ON RELEASE ‚Üí CLOSE MILESTONE & MOVE OPEN ISSUES
            if (context.eventName === 'release' && context.payload.action === 'published') {
              const tag = context.payload.release.tag_name;
              const version = extractVersion(tag);
              if (!version) return;

              const milestoneTitle = `v${version}`;
              console.log(`Release published: ${tag}, searching milestone ${milestoneTitle}`);

              const allMilestones = await github.rest.issues.listMilestones({ owner: org, repo, state: 'all' });
              const current = allMilestones.data.find(m => m.title === milestoneTitle);
              if (!current) {
                console.log(`‚ö†Ô∏è Milestone ${milestoneTitle} not found`);
                return;
              }

              const sorted = allMilestones.data
                .filter(m => m.title.match(/^v\d+\.\d+(\.\d+)?$/))
                .sort((a, b) => compareVersions(extractVersion(a.title), extractVersion(b.title)));

              const index = sorted.findIndex(m => m.title === milestoneTitle);
              const nextMilestone = sorted[index + 1];

              const openIssues = await github.rest.issues.listForRepo({
                owner: org,
                repo,
                milestone: current.number,
                state: 'open',
                per_page: 100
              });

              if (nextMilestone && openIssues.data.length > 0) {
                for (const issue of openIssues.data) {
                  await github.rest.issues.update({
                    owner: org,
                    repo,
                    issue_number: issue.number,
                    milestone: nextMilestone.number
                  });
                  console.log(`‚û°Ô∏è –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –∑–∞–¥–∞—á–∞ #${issue.number} –≤ ${nextMilestone.title}`);
                }
              }

              await github.rest.issues.updateMilestone({
                owner: org,
                repo,
                milestone_number: current.number,
                state: 'closed'
              });

              console.log(`üéâ Milestone ${milestoneTitle} –∑–∞–∫—Ä—ã—Ç`);
              return;
            }
