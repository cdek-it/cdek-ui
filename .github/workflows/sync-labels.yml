name: ðŸ”„ Sync Labels to Satellites

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/labels-config.json']

jobs:
  # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼ÐµÑ‚Ð¾Ðº Ð² Hub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
  sync-hub-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels in Hub repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('./.github/labels-config.json')) {
              console.log('âŒ labels-config.json not found');
              return;
            }
            
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            
            console.log('ðŸ”„ Syncing labels in Hub repository...');
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¼ÐµÑ‚ÐºÐ¸ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
            const allLabels = [];
            for (const category of Object.values(config.labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            const configLabelNames = allLabels.map(label => label.name);
            
            console.log(`ðŸ“‹ Processing ${allLabels.length} labels...`);
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¼ÐµÑ‚ÐºÐ¸ Ð² Hub
            const existingLabels = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );
            
            const existingLabelNames = existingLabels.map(label => label.name);
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸ Ð² Hub
            let created = 0;
            let updated = 0;
            let deleted = 0;
            
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ
            for (const existingLabel of existingLabels) {
              if (!configLabelNames.includes(existingLabel.name)) {
                try {
                  await github.rest.issues.deleteLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: existingLabel.name
                  });
                  deleted++;
                  console.log(`ðŸ—‘ï¸ Deleted from Hub: ${existingLabel.name}`);
                } catch (error) {
                  console.log(`âŒ Error deleting ${existingLabel.name}: ${error.message}`);
                }
              }
            }
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
            for (const labelDef of allLabels) {
              try {
                if (existingLabelNames.includes(labelDef.name)) {
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  updated++;
                  console.log(`ðŸ” Updated: ${labelDef.name}`);
                } else {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  created++;
                  console.log(`âœ… Created: ${labelDef.name}`);
                }
              } catch (error) {
                console.log(`âŒ Error with ${labelDef.name}: ${error.message}`);
              }
            }
            
            console.log(`ðŸŽ‰ Hub sync completed! Created: ${created}, Updated: ${updated}, Deleted: ${deleted}`);

  # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Satellites
  sync-satellite-labels:
    runs-on: ubuntu-latest
    needs: sync-hub-labels
    strategy:
      matrix:
        satellite: ['yandex-test', 'ozon-test', 'wildberries-test', 'react-ui-kit', 'vue-ui-kit', 'react-native-ui-kit', 'angular-ui-kit']
    
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels to ${{ matrix.satellite }}
        uses: actions/github-script@v7
        env:
          HUB_PAT: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('./.github/labels-config.json')) {
              console.log('âŒ labels-config.json not found');
              return;
            }
            
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            
            console.log(`ðŸ”„ Syncing labels to ${{ matrix.satellite }}...`);
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¼ÐµÑ‚ÐºÐ¸ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
            const allLabels = [];
            for (const category of Object.values(config.labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            const configLabelNames = allLabels.map(label => label.name);
            
            console.log(`ðŸ“‹ Processing ${allLabels.length} labels for ${{ matrix.satellite }}...`);
            
            try {
              // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ actions/github-script Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼
              // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ PAT Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼
              const response = await fetch(`https://api.github.com/repos/${context.repo.owner}/${{ matrix.satellite }}/labels?per_page=200`, {
                method: 'GET',
                headers: {
                  'Authorization': `token ${process.env.HUB_PAT}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'User-Agent': 'GitHub-Label-Sync'
                }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const existingLabels = await response.json();
              const existingLabelNames = existingLabels.map(label => label.name);
              
              let created = 0;
              let updated = 0;
              let skipped = 0;
              let deleted = 0;
              let failed = 0;
              
              // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ (ÐºÑ€Ð¾Ð¼Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ…)
              for (const existingLabel of existingLabels) {
                if (!configLabelNames.includes(existingLabel.name) && 
                    existingLabel.name !== 'state/from-hub' &&
                    existingLabel.name !== 'state/routed' &&
                    existingLabel.name !== 'state/auto-created') {
                  try {
                    const deleteResponse = await fetch(`https://api.github.com/repos/${context.repo.owner}/${{ matrix.satellite }}/labels/${encodeURIComponent(existingLabel.name)}`, {
                      method: 'DELETE',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    });
                    
                    if (deleteResponse.ok) {
                      deleted++;
                      console.log(`ðŸ—‘ï¸ Deleted from ${{ matrix.satellite }}: ${existingLabel.name}`);
                    } else {
                      throw new Error(`HTTP ${deleteResponse.status}`);
                    }
                    
                    // Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                  } catch (error) {
                    console.log(`âŒ Error deleting ${existingLabel.name} from ${{ matrix.satellite }}: ${error.message}`);
                  }
                }
              }
              
              // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
              for (const labelDef of allLabels) {
                try {
                  // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ satellite/ Ð»ÐµÐ¹Ð±Ð»Ñ‹
                  if (labelDef.name.startsWith('satellite/')) {
                    skipped++;
                    console.log(`â­ï¸ Skipped satellite label: ${labelDef.name}`);
                    continue;
                  }
                  
                  const labelData = {
                    name: labelDef.name,
                    color: labelDef.color || 'ededed', // Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½
                    description: labelDef.description || ''
                  };
                  
                  if (existingLabelNames.includes(labelDef.name)) {
                    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð¼ÐµÑ‚ÐºÑƒ
                    const updateResponse = await fetch(`https://api.github.com/repos/${context.repo.owner}/${{ matrix.satellite }}/labels/${encodeURIComponent(labelDef.name)}`, {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(labelData)
                    });
                    
                    if (updateResponse.ok) {
                      updated++;
                      console.log(`ðŸ” Updated in ${{ matrix.satellite }}: ${labelDef.name}`);
                    } else {
                      const errorText = await updateResponse.text();
                      throw new Error(`HTTP ${updateResponse.status}: ${errorText}`);
                    }
                  } else {
                    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð¼ÐµÑ‚ÐºÑƒ
                    const createResponse = await fetch(`https://api.github.com/repos/${context.repo.owner}/${{ matrix.satellite }}/labels`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(labelData)
                    });
                    
                    if (createResponse.ok) {
                      created++;
                      console.log(`âœ… Created in ${{ matrix.satellite }}: ${labelDef.name}`);
                    } else {
                      const errorText = await createResponse.text();
                      throw new Error(`HTTP ${createResponse.status}: ${errorText}`);
                    }
                  }
                  
                  // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ rate limits
                  await new Promise(resolve => setTimeout(resolve, 100));
                  
                } catch (error) {
                  failed++;
                  console.log(`âŒ Error with ${labelDef.name} in ${{ matrix.satellite }}: ${error.message}`);
                }
              }
              
              console.log(`ðŸŽ‰ ${{ matrix.satellite }} sync completed! Created: ${created}, Updated: ${updated}, Deleted: ${deleted}, Skipped: ${skipped}, Failed: ${failed}`);
              
              if (failed > 0) {
                throw new Error(`Failed to sync ${failed} labels to ${{ matrix.satellite }}`);
              }
              
            } catch (error) {
              console.log(`ðŸ’¥ Failed to sync ${{ matrix.satellite }}: ${error.message}`);
            }
