name: üîÑ Sync Labels to Satellites

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/labels-config.json']

jobs:

  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ Hub (–∏—Å–ø–æ–ª—å–∑—É–µ–º GITHUB_TOKEN)
  sync-hub-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels in Hub repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            
            console.log('üîÑ Syncing labels in Hub repository...');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            const allLabels = [];
            for (const category of Object.values(config.labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            console.log(`üìã Processing ${allLabels.length} labels...`);
            
            // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏ –≤ Hub
            const existingLabels = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );
            
            const existingLabelNames = existingLabels.map(label => label.name);
            
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –≤ Hub
            let created = 0;
            let updated = 0;
            
            for (const labelDef of allLabels) {
              try {
                if (existingLabelNames.includes(labelDef.name)) {
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  updated++;
                  console.log(`üîÅ Updated: ${labelDef.name}`);
                } else {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  created++;
                  console.log(`‚úÖ Created: ${labelDef.name}`);
                }
              } catch (error) {
                console.log(`‚ùå Error with ${labelDef.name}: ${error.message}`);
              }
            }
            
            console.log(`üéâ Hub sync completed! Created: ${created}, Updated: ${updated}`);

  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ Satellites (–∏—Å–ø–æ–ª—å–∑—É–µ–º PAT)
  sync-satellite-labels:
    runs-on: ubuntu-latest
    needs: [sync-hub-labels]
    strategy:
      matrix:
        satellite: ['yandex-test', 'ozon-test', 'wildberries-test']
    
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels to ${{ matrix.satellite }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å PAT –¥–ª—è satellite –æ–ø–µ—Ä–∞—Ü–∏–π
            const patGithub = github.getOctokit('${{ secrets.SYNC_ACCESS_TOKEN }}');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º owner –∏ repo
            let targetOwner, targetRepo;
            if ('${{ matrix.satellite }}'.includes('/')) {
              [targetOwner, targetRepo] = '${{ matrix.satellite }}'.split('/');
            } else {
              targetOwner = context.repo.owner;
              targetRepo = '${{ matrix.satellite }}';
            }
            
            console.log(`üîÑ Syncing labels to ${targetOwner}/${targetRepo}...`);
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            const allLabels = [];
            for (const category of Object.values(config.labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            console.log(`üìã Processing ${allLabels.length} labels for ${targetRepo}...`);
            
            try {
              // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏ –≤ satellite
              const existingLabels = await patGithub.paginate(
                patGithub.rest.issues.listLabelsForRepo,
                {
                  owner: targetOwner,
                  repo: targetRepo,
                  per_page: 100
                }
              );
              
              const existingLabelNames = existingLabels.map(label => label.name);
              
              // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏
              let created = 0;
              let updated = 0;
              let errors = 0;
              
              for (const labelDef of allLabels) {
                try {
                  if (existingLabelNames.includes(labelDef.name)) {
                    await patGithub.rest.issues.updateLabel({
                      owner: targetOwner,
                      repo: targetRepo,
                      name: labelDef.name,
                      color: labelDef.color,
                      description: labelDef.description || ''
                    });
                    updated++;
                    console.log(`üîÅ Updated in ${targetRepo}: ${labelDef.name}`);
                  } else {
                    await patGithub.rest.issues.createLabel({
                      owner: targetOwner,
                      repo: targetRepo,
                      name: labelDef.name,
                      color: labelDef.color,
                      description: labelDef.description || ''
                    });
                    created++;
                    console.log(`‚úÖ Created in ${targetRepo}: ${labelDef.name}`);
                  }
                } catch (error) {
                  errors++;
                  console.log(`‚ùå Error with ${labelDef.name} in ${targetRepo}: ${error.message}`);
                }
              }
              
              console.log(`üéâ ${targetRepo} sync completed! Created: ${created}, Updated: ${updated}, Errors: ${errors}`);
              
            } catch (error) {
              console.log(`üí• Failed to sync ${targetRepo}: ${error.message}`);
            }
