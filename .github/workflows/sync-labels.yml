name: ğŸ”„ Sync Labels to Satellites

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/labels-config.json']

jobs:
  # Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ¾Ğº Ğ² Hub Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸
  sync-hub-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels in Hub repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            const labels = config.labels;
            
            console.log(`ğŸ”„ Syncing ${Object.keys(labels).reduce((acc, key) => acc + labels[key].length, 0)} labels in Hub...`);
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
            const allLabels = [];
            for (const category of Object.values(labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ² Hub
            const existingLabels = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );
            
            const existingLabelNames = existingLabels.map(label => label.name);
            
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ² Hub
            let hubCreated = 0;
            let hubUpdated = 0;
            
            for (const labelDef of allLabels) {
              try {
                if (existingLabelNames.includes(labelDef.name)) {
                  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ¼ĞµÑ‚ĞºÑƒ
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  hubUpdated++;
                  console.log(`ğŸ”„ Updated in Hub: ${labelDef.name}`);
                } else {
                  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¼ĞµÑ‚ĞºÑƒ
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelDef.name,
                    color: labelDef.color,
                    description: labelDef.description || ''
                  });
                  hubCreated++;
                  console.log(`âœ… Created in Hub: ${labelDef.name}`);
                }
              } catch (error) {
                console.log(`âŒ Error with ${labelDef.name} in Hub: ${error.message}`);
              }
            }
            
            console.log(`ğŸ‰ Hub sync completed! Created: ${hubCreated}, Updated: ${hubUpdated}`);

  # Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ¾Ğº Ğ² Satellite Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ÑÑ…
  sync-satellite-labels:
    runs-on: ubuntu-latest
    needs: sync-hub-labels
    strategy:
      matrix:
        satellite: ['yandex-test', 'ozon-test', 'wildberries-test']
    
    steps:
      - name: Checkout Hub
        uses: actions/checkout@v4
        
      - name: Sync labels to ${{ matrix.satellite }}
        uses: actions/github-script@v7
        env:
          TARGET_REPO: ${{ matrix.satellite }}
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./.github/labels-config.json', 'utf8'));
            const labels = config.labels;
            
            console.log(`ğŸ”„ Syncing ${Object.keys(labels).reduce((acc, key) => acc + labels[key].length, 0)} labels to ${process.env.TARGET_REPO}...`);
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
            const allLabels = [];
            for (const category of Object.values(labels)) {
              if (Array.isArray(category)) {
                allLabels.push(...category);
              }
            }
            
            try {
              // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ² satellite
              const existingLabels = await github.paginate(
                github.rest.issues.listLabelsForRepo,
                {
                  owner: context.repo.owner,
                  repo: process.env.TARGET_REPO,
                  per_page: 100
                }
              );
              
              const existingLabelNames = existingLabels.map(label => label.name);
              
              // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ² satellite
              let created = 0;
              let updated = 0;
              
              for (const labelDef of allLabels) {
                try {
                  if (existingLabelNames.includes(labelDef.name)) {
                    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ¼ĞµÑ‚ĞºÑƒ
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: process.env.TARGET_REPO,
                      name: labelDef.name,
                      color: labelDef.color,
                      description: labelDef.description || ''
                    });
                    updated++;
                    console.log(`ğŸ”„ Updated in ${process.env.TARGET_REPO}: ${labelDef.name}`);
                  } else {
                    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¼ĞµÑ‚ĞºÑƒ
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: process.env.TARGET_REPO,
                      name: labelDef.name,
                      color: labelDef.color,
                      description: labelDef.description || ''
                    });
                    created++;
                    console.log(`âœ… Created in ${process.env.TARGET_REPO}: ${labelDef.name}`);
                  }
                } catch (error) {
                  console.log(`âŒ Error with ${labelDef.name} in ${process.env.TARGET_REPO}: ${error.message}`);
                }
              }
              
              console.log(`ğŸ‰ ${process.env.TARGET_REPO} sync completed! Created: ${created}, Updated: ${updated}`);
              
            } catch (error) {
              console.log(`âŒ Failed to sync to ${process.env.TARGET_REPO}: ${error.message}`);
            }

  # ĞÑ‚Ñ‡ĞµÑ‚ Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
  generate-sync-report:
    runs-on: ubuntu-latest
    needs: [sync-hub-labels, sync-satellite-labels]
    steps:
      - name: Create synchronization report
        uses: actions/github-script@v7
        with:
          script: |
            const satellites = ['yandex-test', 'ozon-test', 'wildberries-test'];
            
            const report = `# ğŸ·ï¸ Labels Synchronization Report

**Generated**: ${new Date().toLocaleString()}
**Triggered by**: ${context.payload.head_commit ? 'Code push' : 'Manual trigger'}

## ğŸ“Š Sync Status

### Hub Repository
- âœ… Labels synchronized successfully
- Repository: ${context.repo.owner}/${context.repo.repo}

### Satellite Repositories
${satellites.map(satellite => `
#### ${satellite}
- âœ… Labels synchronized successfully
- Repository: ${context.repo.owner}/${satellite}
`).join('')}

## ğŸ”„ Next Steps
- All labels are now consistent across all repositories
- New issues will use the synchronized labels
- To modify labels, update \`.github/labels-config.json\` in Hub

---

_This report was automatically generated by GitHub Actions_`;

            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ issue Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ¼
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ·ï¸ Labels Sync Complete - ${new Date().toLocaleDateString()}`,
              body: report,
              labels: ['automated', 'labels-sync', 'report']
            });

            console.log('ğŸ“Š Sync report created successfully!');
