name: Auto-manage assignees by labels

on:
  issues:
    types: [opened, labeled, unlabeled, edited]
  pull_request:
    types: [opened, labeled, unlabeled, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  assign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4


      - name: Auto-manage assignees from repo labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;
            const item = context.payload.issue || context.payload.pull_request;

            if (!item) {
              console.log("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω issue –∏–ª–∏ PR");
              return;
            }

            const number = item.number;
            const labels = item.labels.map(l => l.name);
            console.log("üè∑Ô∏è –¢–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã:", labels.join(", "));

            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–µ–π–±–ª–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
            const repoLabelsResp = await github.rest.issues.listLabelsForRepo({ owner: org, repo });
            const repoLabels = repoLabelsResp.data.map(l => l.name);

            // –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ label ‚Üí team
            const labelToTeam = {
              "area/design-system": "design-team",
              "area/components": "frontend-specialists",
              "area/accessibility": "a11y-experts",
              "area/performance": "performance-team",
              "area/tooling": "devops-team",
              "area/i18n": "i18n-team",
              "area/mobile": "mobile-team"
            };

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
            const validLabels = labels.filter(l => repoLabels.includes(l));
            console.log("‚úÖ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ª–µ–π–±–ª—ã:", validLabels.join(", "));

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏—Ö –∞—Å—Å–∞–π–Ω–∏
            const currentAssignees = item.assignees?.map(a => a.login) || [];
            console.log("üë§ –¢–µ–∫—É—â–∏–µ –∞—Å—Å–∞–π–Ω–∏:", currentAssignees.join(", ") || "–Ω–µ—Ç");

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ–ª–∞–µ–º—ã—Ö –∞—Å—Å–∞–π–Ω–∏
            const desiredAssignees = new Set();
            for (const label of validLabels) {
              const team = labelToTeam[label];
              if (!team) continue;

              try {
                const members = await github.rest.teams.listMembersInOrg({
                  org,
                  team_slug: team,
                });
                members.data.forEach(m => desiredAssignees.add(m.login));
              } catch (error) {
                console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã ${team}: ${error.message}`);
              }
            }

            console.log("‚úÖ –ñ–µ–ª–∞–µ–º—ã–µ –∞—Å—Å–∞–π–Ω–∏:", Array.from(desiredAssignees).join(", ") || "–Ω–µ—Ç");

            // –ö–æ–≥–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –∫–æ–≥–æ —É–±—Ä–∞—Ç—å
            const toAdd = Array.from(desiredAssignees).filter(a => !currentAssignees.includes(a));
            const toRemove = currentAssignees.filter(a => !desiredAssignees.has(a));

            console.log("‚ûï –î–æ–±–∞–≤–∏—Ç—å:", toAdd.join(", ") || "–Ω–µ—Ç");
            console.log("‚ûñ –£–¥–∞–ª–∏—Ç—å:", toRemove.join(", ") || "–Ω–µ—Ç");

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö
            if (toAdd.length > 0) {
              try {
                await github.rest.issues.addAssignees({
                  owner: org,
                  repo,
                  issue_number: number,
                  assignees: toAdd
                });
                console.log("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∞—Å—Å–∞–π–Ω–∏");
              } catch (error) {
                console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞—Å—Å–∞–π–Ω–∏: ${error.message}`);
              }
            }

            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏—Ö
            if (toRemove.length > 0) {
              try {
                await github.rest.issues.removeAssignees({
                  owner: org,
                  repo,
                  issue_number: number,
                  assignees: toRemove
                });
                console.log("‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ–Ω—É–∂–Ω—ã–µ –∞—Å—Å–∞–π–Ω–∏");
              } catch (error) {
                console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞—Å—Å–∞–π–Ω–∏: ${error.message}`);
              }
            }
