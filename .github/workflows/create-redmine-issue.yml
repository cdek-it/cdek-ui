name: üöÄ Create Redmine Issue from GitHub

on:
  issues:
    types: [labeled]

jobs:
  create-redmine-issue:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'state/to-redmine'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Redmine Issue
        uses: actions/github-script@v7
        env:
          REDMINE_API_KEY: ${{ secrets.REDMINE_API_KEY }}
          REDMINE_URL: ${{ secrets.REDMINE_URL }}
        with:
          script: |
            const { issue } = context.payload;
            
            console.log('üîÑ Creating Redmine issue from GitHub issue #' + issue.number);
            
            const hasRedmineCreatedLabel = issue.labels.some(l => l.name === 'state/redmine-created');
            if (hasRedmineCreatedLabel) {
              console.log('‚ÑπÔ∏è Redmine issue already created, skipping');
              return;
            }

             function formatDescription(githubIssue) {
              return `GitHub Issue #${githubIssue.number}
              
              *–°–æ–∑–¥–∞–Ω–∞ –∏–∑ GitHub: ${githubIssue.html_url}*
              *–ê–≤—Ç–æ—Ä: ${githubIssue.user.login}*
              *–°–æ–∑–¥–∞–Ω–∞: ${new Date(githubIssue.created_at).toLocaleString()}*
              
              –û–ø–∏—Å–∞–Ω–∏–µ
              
              ${githubIssue.body || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
              
              –ú–µ—Ç–∫–∏ GitHub
              
              ${githubIssue.labels.map(label => `* ${label.name}`).join('\n')}
              
              ---
              *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –∏–∑ GitHub*`;
            }
            
            await createRedmineIssue(issue);
            
            async function createRedmineIssue(githubIssue) {
              try {
                const redmineData = {
                  issue: {
                    project_id: '${{ secrets.REDMINE_PROJECT_ID }}', // ID –ø—Ä–æ–µ–∫—Ç–∞ –≤ Redmine
                    tracker_id: '${{ secrets.REDMINE_TRACKER_ID }}', // ID —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏ (–±–∞–≥/—Ñ–∏—á–∞ –∏ —Ç.–¥.)
                    subject: `[GitHub #${githubIssue.number}] ${githubIssue.title}`,
                    description: formatDescription(githubIssue),
                    priority_id: 2,
                    status_id: 20, // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                    assigned_to_id: '${{ secrets.REDMINE_ASSIGNED_ID }}',
                    custom_fields: `[{id: 1563, value: #${githubIssue.number}}]`
                  }
                };
                
                console.log('üì§ Sending to Redmine:', JSON.stringify(redmineData, null, 2));
                
                const response = await fetch(`${process.env.REDMINE_URL}/issues.json`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Redmine-API-Key': '${{ secrets.REDMINE_API_KEY }}'
                  },
                  body: JSON.stringify(redmineData)
                });
                
                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`Redmine API error: ${response.status} - ${errorText}`);
                }
                
                const redmineIssue = await response.json();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ GitHub issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: `‚úÖ **–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ Redmine**\n\n` +
                        `**Redmine Issue**: [#${redmineIssue.issue.id}](${process.env.REDMINE_URL}/issues/${redmineIssue.issue.id})\n` +
                        `**–°—Ç–∞—Ç—É—Å**: ${redmineIssue.issue.status.name}\n` +
                        `**–°–æ–∑–¥–∞–Ω–∞**: ${new Date().toLocaleString()}`
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª –æ—Ç–º–µ—Ç–∫–∏ –æ —Å–æ–∑–¥–∞–Ω–∏–∏
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  labels: ['state/redmine-created']
                });

                 // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ GitHub issue
                const updatedBody = githubIssue.body + `\n\n---\n\n` +
                  `## üîó Redmine Integration\n\n` +
                  `‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ Redmine: [#${redmineIssue.issue.id}](${process.env.REDMINE_URL}/issues/${redmineIssue.issue.id})`;
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: updatedBody
                });
                
                console.log('‚úÖ Created Redmine issue #' + redmineIssue.issue.id);
                
              } catch (error) {
                console.log('‚ùå Failed to create Redmine issue: ' + error.message);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: `‚ùå **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ Redmine**\n\n` +
                        `\`\`\`\n${error.message}\n\`\`\``
                });
              }
            }
