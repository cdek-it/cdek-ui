name: üîÑ Sync from Hub to Satellite

on:
  issues:
    types: [closed, reopened, labeled, unlabeled, edited]
  issue_comment:
    types: [created, edited]

jobs:
  sync-to-satellite:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'state/routed')
    
    steps:
      - name: Sync status and labels to satellite
        uses: actions/github-script@v7
        env:
          SYNC_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          script: |
            const { issue, label, comment } = context.payload;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–¥–∞—á–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –≤ satellite
            const isRouted = issue.labels.some(l => l.name === 'state/routed');
            if (!isRouted) {
              console.log('‚ÑπÔ∏è Issue not routed to satellite, skipping sync');
              return;
            }

            // –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ satellite issue –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
            const satelliteInfo = await findSatelliteInfoFromComments(issue.number);
            if (!satelliteInfo) {
              console.log('‚ùå Satellite issue reference not found in comments');
              return;
            }

            // –î–ª—è —Å–æ–±—ã—Ç–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            if (context.eventName === 'issue_comment') {
              await syncCommentToSatellite(comment, issue, satelliteInfo);
              return;
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–µ–π–±–ª–æ–≤
            if (context.eventName === 'issues' && (context.payload.action === 'labeled' || context.payload.action === 'unlabeled')) {
              await syncLabelsToSatellite(issue, satelliteInfo, label);
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞
            await syncStatusToSatellite(issue, satelliteInfo);

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏—è
            if (context.eventName === 'issues' && context.payload.action === 'edited') {
              await syncContentToSatellite(issue, satelliteInfo);
            }

            async function findSatelliteInfoFromComments(issueNumber) {
              try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–µ
                const commentsResponse = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                const comments = commentsResponse.data;

                // –ò—â–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–∑–¥–∞–Ω–∏–∏ satellite issue
                const creationComment = comments.find(comment => 
                  comment.body.includes('‚úÖ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞ –≤ satellite') &&
                  comment.body.includes('Satellite Issue')
                );

                if (!creationComment) {
                  console.log('‚ùå Satellite creation comment not found');
                  return null;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                const satelliteMatch = creationComment.body.match(/Satellite Issue.*#(\d+).*\((https:\/\/github\.com\/[^\/]+\/[^\/]+\/issues\/\d+)\)/);
                const satelliteRepoMatch = creationComment.body.match(/Satellite.*`([^`]+)`/);
                
                if (!satelliteMatch || !satelliteRepoMatch) {
                  console.log('‚ùå Could not extract satellite info from comment');
                  return null;
                }

                const satelliteIssueNumber = parseInt(satelliteMatch[1]);
                const satelliteIssueUrl = satelliteMatch[2];
                const satelliteRepo = satelliteRepoMatch[1];
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º owner –∏ repo –∏–∑ URL
                const urlParts = satelliteIssueUrl.split('/');
                const satelliteOwner = urlParts[3];
                const satelliteRepoName = urlParts[4];

                return {
                  number: satelliteIssueNumber,
                  url: satelliteIssueUrl,
                  repo: satelliteRepo,
                  owner: satelliteOwner,
                  repoName: satelliteRepoName
                };

              } catch (error) {
                console.log('‚ùå Error searching satellite info in comments: ' + error.message);
                return null;
              }
            }

            async function syncStatusToSatellite(hubIssue, satelliteInfo) {
              try {
                let state = 'open';

                if (hubIssue.state === 'closed') {
                  state = 'closed';
                } else if (hubIssue.state === 'open' && context.payload.action === 'reopened') {
                  state = 'open';
                }

                if (!state) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ satellite
                const response = await fetch(
                  `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}`,
                  {
                    method: 'PATCH',
                    headers: {
                      'Authorization': `token ${process.env.SYNC_TOKEN}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      state: state
                    })
                  }
                );

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log(`‚úÖ Synced status to Satellite ${satelliteInfo.repo}#${satelliteInfo.number}: ${state}`);

              } catch (error) {
                console.log(`‚ùå Failed to sync status to Satellite: ${error.message}`);
              }
            }

            async function syncLabelsToSatellite(hubIssue, satelliteInfo, changedLabel) {
              try {
                const syncPrefixes = ['status/', 'priority/', 'area/', 'type/'];
                const changedLabelName = changedLabel?.name;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –ª–µ–π–±–ª –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã–º
                const shouldSync = syncPrefixes.some(prefix => changedLabelName?.startsWith(prefix));
                if (!shouldSync) {
                  console.log('‚ÑπÔ∏è Label not in sync scope: ' + changedLabelName);
                  return;
                }

                console.log('üîÑ Syncing label to satellite: ' + changedLabelName);

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã hub issue
                const currentHubLabels = hubIssue.labels.map(l => l.name);

                // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–µ–π–±–ª—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const labelsToSync = currentHubLabels.filter(labelName => 
                  syncPrefixes.some(prefix => labelName.startsWith(prefix))
                );

                console.log('üìã Labels to sync to satellite: ' + labelsToSync.join(', '));

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã satellite issue
                const satelliteResponse = await fetch(
                  `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}`,
                  {
                    headers: {
                      'Authorization': `token ${process.env.SYNC_TOKEN}`,
                      'Accept': 'application/vnd.github.v3+json'
                    }
                  }
                );

                if (!satelliteResponse.ok) {
                  throw new Error(`Failed to get satellite issue: ${satelliteResponse.status}`);
                }

                const satelliteIssue = await satelliteResponse.json();
                const currentSatelliteLabels = satelliteIssue.labels.map(l => l.name);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ª–µ–π–±–ª—ã –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ satellite
                const labelsToRemove = [];

                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –Ω–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –ª–µ–π–±–ª –≤ hub –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å satellite
                for (const prefix of syncPrefixes) {
                  const hubLabelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                  const satelliteLabelForPrefix = currentSatelliteLabels.find(label => label.startsWith(prefix));

                  // –ï—Å–ª–∏ –≤ satellite –µ—Å—Ç—å –ª–µ–π–±–ª —ç—Ç–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –Ω–æ –≤ hub –µ–≥–æ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –¥—Ä—É–≥–æ–π - —É–¥–∞–ª—è–µ–º
                  if (satelliteLabelForPrefix && satelliteLabelForPrefix !== hubLabelForPrefix) {
                    labelsToRemove.push(satelliteLabelForPrefix);
                  }
                }

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–µ–π–±–ª—ã –∏–∑ satellite
                for (const labelToRemove of labelsToRemove) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}/labels/${encodeURIComponent(labelToRemove)}`,
                    {
                      method: 'DELETE',
                      headers: {
                        'Authorization': `token ${process.env.SYNC_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  console.log('üóëÔ∏è Removed label from Satellite: ' + labelToRemove);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ª–µ–π–±–ª—ã (—Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ satellite)
                const labelsToAdd = labelsToSync.filter(labelName => 
                  !currentSatelliteLabels.includes(labelName)
                );

                if (labelsToAdd.length > 0) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.SYNC_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify(labelsToAdd)
                    }
                  );
                  console.log('‚úÖ Added labels to Satellite: ' + labelsToAdd.join(', '));
                }

                console.log(`‚úÖ Synced labels to Satellite ${satelliteInfo.repo}#${satelliteInfo.number}`);

              } catch (error) {
                console.log(`‚ùå Failed to sync labels to Satellite: ${error.message}`);
              }
            }

            async function syncCommentToSatellite(hubComment, hubIssue, satelliteInfo) {
              try {
                console.log('üí¨ Syncing comment to Satellite');

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç –±–æ—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                if (hubComment.user.type === 'Bot' || 
                    hubComment.body.includes('üîÑ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω') ||
                    hubComment.body.includes('üè∑Ô∏è –õ–µ–π–±–ª—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã') ||
                    hubComment.body.includes('‚úÖ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞') ||
                    hubComment.body.includes('üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ Satellite')) {
                  console.log('‚ÑπÔ∏è Skipping bot or system comment');
                  return;
                }

                const commentBody = '**üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ Hub**\n\n' +
                                    '**Hub Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                                    '**–ê–≤—Ç–æ—Ä**: @' + hubComment.user.login + '\n' +
                                    '**–í—Ä–µ–º—è**: ' + new Date(hubComment.created_at).toLocaleString() + '\n\n' +
                                    '---\n\n' +
                                    hubComment.body + '\n\n' +
                                    '---\n\n' +
                                    '*–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*';

                const response = await fetch(
                  `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.SYNC_TOKEN}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: commentBody
                    })
                  }
                );

                if (!response.ok) {
                  throw new Error(`Failed to create comment in satellite: ${response.status}`);
                }

                console.log(`‚úÖ Synced comment to Satellite ${satelliteInfo.repo}#${satelliteInfo.number}`);

              } catch (error) {
                console.log(`‚ùå Failed to sync comment to Satellite: ${error.message}`);
              }
            }

            async function syncContentToSatellite(hubIssue, satelliteInfo) {
              try {
                console.log('üìù Syncing content to Satellite');

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ satellite
                const response = await fetch(
                  `https://api.github.com/repos/${satelliteInfo.owner}/${satelliteInfo.repoName}/issues/${satelliteInfo.number}`,
                  {
                    method: 'PATCH',
                    headers: {
                      'Authorization': `token ${process.env.SYNC_TOKEN}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      title: '[From Hub] ' + hubIssue.title
                    })
                  }
                );

                if (!response.ok) {
                  throw new Error(`Failed to update satellite issue: ${response.status}`);
                }

                console.log(`‚úÖ Synced content to Satellite ${satelliteInfo.repo}#${satelliteInfo.number}`);

              } catch (error) {
                console.log(`‚ùå Failed to sync content to Satellite: ${error.message}`);
              }
            }
