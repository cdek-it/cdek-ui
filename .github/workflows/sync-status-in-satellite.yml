name: 📡 Sync Status from Hub

on:
  issues:
    types: [closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

jobs:
  sync-from-hub:
    runs-on: ubuntu-latest
    steps:
      - name: Check if from Hub and sync status
        uses: actions/github-script@v7
        env:
          HUB_PAT: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          script: |
            const { issue, label, comment } = context.payload;

            // Для событий комментариев проверяем, что комментарий в issue из Hub
            if (context.eventName === 'issue_comment') {
              const issueForComment = context.payload.issue;
              const isFromHub = issueForComment.labels.some(label => label.name === 'state/routed');
              if (!isFromHub) {
                console.log('ℹ️ Not a Hub issue comment, skipping sync');
                return;
              }
              
              // Ищем номер Satellite issue в комментариях
              const satelliteIssueMatch = issueForComment.body.match(/Satellite Issue.*#(\d+)/);
              if (!satelliteIssueMatch) {
                console.log('❌ Satellite issue reference not found in comment issue');
                return;
              }
              
              const satelliteIssueNumber = parseInt(satelliteIssueMatch[1]);
              const [satelliteOwner, satelliteRepoName] = '${{ github.repository }}'.split('/');
              
              await syncCommentToSatellite(comment, issueForComment, satelliteIssueNumber, satelliteOwner, satelliteRepoName);
              return;
            }
            
            // Проверяем что задача создана из Hub
            const isFromHub = issue.labels.some(label => label.name === 'state/routed');
            if (!isFromHub) {
              console.log('ℹ️ Not a Hub issue, skipping sync');
              return;
            }
            
            const satelliteIssueNumber = parseInt(satelliteIssueNumber[1]);
            const satelliteRepo = '${{ github.repository }}';
            
            // Определяем тип события для синхронизации лейблов
            if (context.eventName === 'issues' && (context.payload.action === 'labeled' || context.payload.action === 'unlabeled')) {
              await syncLabelsToSatellite(issue, satelliteIssueNumber, satelliteRepo, label);
            }
            
            await syncStatusToSatellite(issue, satelliteIssueNumber, satelliteRepo);
            
            async function syncStatusToSatellite(hubIssue, satelliteIssueNumber, satelliteRepo) {
              let status = '';
              let statusMessage = '';
              let shouldReopen = false;
              
              // Определяем статус на основе состояния и лейблов
              if (hubIssue.state === 'closed') {
                status = 'closed';
                statusMessage = '✅ Завершено в Hub';
              } else if (hubIssue.state === 'open') {
                // Если issue была переоткрыта (reopened)
                if (context.payload.action === 'reopened') {
                  status = 'open';
                  statusMessage = '🔄 Переоткрыто в Hub';
                  shouldReopen = true;
                  }
               } else if (hubIssue.state === 'open') {
                // Проверяем наличие лейбла status/in-progress
                const hasInProgressLabel = hubIssue.labels.some(label => label.name === 'status/in-progress');
                if (hasInProgressLabel) {
                  status = 'status/in-progress';
                  statusMessage = '🔧 В работе';
                } else {
                  status = 'open';
                  statusMessage = '📋 Открыто в Hub';
                }
              }
              
              if (!status) return;
              
              // Отправляем статус в Satellite
              await updateSatelliteStatus(satelliteIssueNumber, status, statusMessage, hubIssue, satelliteRepo, shouldReopen);
            }
            
            async function syncLabelsToSatellite(hubIssue, satelliteIssueNumber, satelliteRepo, changedLabel) {
              try {
                const syncPrefixes = ['status/', 'priority/', 'area/', 'type/'];
                const changedLabelName = changedLabel?.name;
                
                // Проверяем, относится ли измененный лейбл к синхронизируемым
                const shouldSync = syncPrefixes.some(prefix => changedLabelName?.startsWith(prefix));
                if (!shouldSync) {
                  console.log('ℹ️ Label not in sync scope: ' + changedLabelName);
                  return;
                }
                
                console.log('🔄 Syncing label: ' + changedLabelName);
                
                // Получаем текущие лейблы hub issue
                const currentLabels = hubIssue.labels.map(l => l.name);
                
                // Фильтруем лейблы для синхронизации - берем ВСЕ лейблы с нужными префиксами
                const labelsToSync = currentLabels.filter(labelName => 
                  syncPrefixes.some(prefix => labelName.startsWith(prefix))
                );
                
                console.log('📋 All labels to sync from hub: ' + labelsToSync.join(', '));
                
                // Получаем текущие лейблы satellite issue используя PAT
                const satelliteIssueResponse = await fetch(
                  `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                  {
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Accept': 'application/vnd.github.v3+json'
                    }
                  }
                );
                
                if (!satelliteIssueResponse.ok) {
                  throw new Error(`Failed to get satellite issue: ${satelliteIssueResponse.status}`);
                }
                
                const satelliteIssue = await satelliteIssueResponse.json();
                const currentSatelliteLabels = satelliteIssue.labels.map(l => l.name);
                
                // Определяем какие лейблы нужно удалить из satellite
                const labelsToRemove = [];
                
                // Для каждого префикса находим текущий лейбл в satellite и сравниваем с hub
                for (const prefix of syncPrefixes) {
                  const hubLabelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                  const satelliteLabelForPrefix = currentSatelliteLabels.find(label => label.startsWith(prefix));
                  
                  // Если в satellite есть лейбл этого префикса, но в hub его нет или он другой - удаляем
                  if (satelliteLabelForPrefix && satelliteLabelForPrefix !== hubLabelForPrefix) {
                    labelsToRemove.push(satelliteLabelForPrefix);
                  }
                  
                  // Если в hub есть лейбл, но в satellite его нет - он будет добавлен ниже
                }
                
                // Удаляем старые лейблы из satellite
                for (const labelToRemove of labelsToRemove) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}/labels/${encodeURIComponent(labelToRemove)}`,
                    {
                      method: 'DELETE',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  console.log('🗑️ Removed label from Satellite: ' + labelToRemove);
                }
                
                // Добавляем новые лейблы (только те, которых нет в satellite)
                const labelsToAdd = labelsToSync.filter(labelName => 
                  !currentSatelliteLabels.includes(labelName)
                );
                
                if (labelsToAdd.length > 0) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify(labelsToAdd)
                    }
                  );
                  console.log('✅ Added labels to Satellite: ' + labelsToAdd.join(', '));
                }
                
                // Создаем комментарий о синхронизации лейблов
                if (labelsToRemove.length > 0 || labelsToAdd.length > 0) {
                  const commentLines = [];
                  
                  if (labelsToAdd.length > 0) {
                    commentLines.push('**Добавлены**: `' + labelsToAdd.join('`, `') + '`');
                  }
                  
                  if (labelsToRemove.length > 0) {
                    commentLines.push('**Удалены**: `' + labelsToRemove.join('`, `') + '`');
                  }
                  
                  // Добавляем информацию о текущих синхронизированных лейблах
                  const currentSyncInfo = [];
                  for (const prefix of syncPrefixes) {
                    const labelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                    if (labelForPrefix) {
                      currentSyncInfo.push(`**${prefix}**: \`${labelForPrefix}\``);
                    }
                  }
                  
                  if (currentSyncInfo.length > 0) {
                    commentLines.push('**Текущие синхронизированные лейблы**:\n' + currentSyncInfo.join('\n'));
                  }
                }
                
                console.log(`✅ Synced labels to Satellite #${satelliteIssueNumber}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync labels to Satellite: ${error.message}`);
              }
            }

            async function syncCommentToSatellite(hubComment, hubIssue, satelliteIssueNumber, satelliteOwner, satelliteRepo) {
              try {
                console.log('💬 Syncing comment to Satellite');
                
                // Пропускаем комментарии от ботов и системные комментарии
                if (hubComment.user.type === 'Bot' || 
                    hubComment.body.includes('🔄 Статус обновлен') ||
                    hubComment.body.includes('🏷️ Лейблы синхронизированы') ||
                    hubComment.body.includes('✅ Задача автоматически создана')) {
                  console.log('ℹ️ Skipping bot or system comment');
                  return;
                }
                
                const commentBody = '**💬 Комментарий из Hub**\n\n' +
                                    '**Hub Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                                    '**Автор**: @' + hubComment.user.login + '\n' +
                                    '**Время**: ' + new Date(hubComment.created_at).toLocaleString() + '\n\n' +
                                    '---\n\n' +
                                    hubComment.body + '\n\n' +
                                    '---\n\n' +
                                    '*Комментарий синхронизирован автоматически*';
                
                const response = await fetch(
                  `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: commentBody
                    })
                  }
                );
                
                if (!response.ok) {
                  throw new Error(`Failed to create comment in satellite: ${response.status}`);
                }
                
                console.log(`✅ Synced comment to Satellite #${satelliteIssueNumber}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync comment to Satellite: ${error.message}`);
              }
            }
            
            async function updateSatelliteStatus(satelliteIssueNumber, status, statusMessage, hubIssue, satelliteRepo, shouldReopen = false) {
              try {
                // Обновляем комментарий в Satellite используя PAT
                await fetch(
                  `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: '**🔄 Статус обновлен из Hub**\n\n' +
                            '**Hub Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                            '**Статус**: ' + statusMessage + '\n' +
                            '**Время**: ' + new Date().toLocaleString()
                    })
                  }
                );
                
                // Обновляем метки статуса в Satellite
                const statusLabels = {
                  'in-progress': 'status/in-progress'
                };
                
                const newStatusLabel = statusLabels[status];
                if (newStatusLabel) {
                  // Получаем текущие лейблы satellite issue
                  const satelliteIssueResponse = await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  
                  if (!satelliteIssueResponse.ok) {
                    throw new Error(`Failed to get satellite issue: ${satelliteIssueResponse.status}`);
                  }
                  
                  const satelliteIssue = await satelliteIssueResponse.json();
                  
                  // Удаляем старые статусные метки
                  const oldStatusLabels = satelliteIssue.labels
                    .filter(label => label.name.startsWith('status/') && label.name !== newStatusLabel)
                    .map(label => label.name);
                  
                  for (const oldLabel of oldStatusLabels) {
                    await fetch(
                      `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}/labels/${encodeURIComponent(oldLabel)}`,
                      {
                        method: 'DELETE',
                        headers: {
                          'Authorization': `token ${process.env.HUB_PAT}`,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      }
                    );
                  }
                  
                  // Добавляем новую статусную метку
                  await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify([newStatusLabel])
                    }
                  );
                }
                
                // Если задача завершена в Hub, закрываем в Satellite
                if (status === 'closed') {
                  await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'closed'
                      })
                    }
                  );
                }
                if (shouldReopen) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'open'
                      })
                    }
                  );
                  console.log('🔓 Reopened issue in Satellite');
                }
                
                
                console.log(`✅ Synced status to Satellite #${satelliteIssueNumber}: ${status}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync status to Satellite: ${error.message}`);
              }
            }
