name: 📡 Sync Status to Satellite

on:
  issues:
    types: [closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

jobs:
  sync-to-satellite:
    runs-on: ubuntu-latest
    steps:
      - name: Check if routed to Satellite and sync status
        uses: actions/github-script@v7
        env:
          SATELLITE_PAT: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          script: |
            const { issue, label, comment } = context.payload;

            // Функция для поиска информации о Satellite в комментариях
            async function findSatelliteInfo(issueNumber) {
              try {
                console.log(`🔍 Searching for satellite info in issue #${issueNumber}`);
                
                // Получаем все комментарии к issue
                const commentsResponse = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                console.log(`📝 Found ${commentsResponse.data.length} comments`);
                
                // Ищем комментарий с информацией о создании Satellite issue
                const creationComment = commentsResponse.data.find(comment => 
                  comment.body.includes('✅ **Задача автоматически создана в satellite!**') ||
                  comment.body.includes('Satellite Issue') ||
                  comment.body.includes('**Satellite**:') ||
                  comment.body.includes('**Issue**: [#')
                );
                
                if (!creationComment) {
                  console.log('❌ Satellite creation comment not found');
                  console.log('Available comments:');
                  commentsResponse.data.forEach((c, i) => {
                    console.log(`  ${i + 1}. ${c.body.substring(0, 100)}...`);
                  });
                  return null;
                }
                
                console.log('✅ Found satellite creation comment');
                
                // Ищем номер Satellite issue
                const satelliteIssueMatch = creationComment.body.match(/Issue.*\[#(\d+)\]/) || 
                                           creationComment.body.match(/Issue.*#(\d+)/);
                if (!satelliteIssueMatch) {
                  console.log('❌ Satellite issue number not found in comment');
                  console.log('Comment body:', creationComment.body);
                  return null;
                }
                
                // Ищем репозиторий Satellite
                const satelliteRepoMatch = creationComment.body.match(/\*\*Satellite\*\*: `([^`]+)`/) ||
                                          creationComment.body.match(/Satellite.*`([^`]+)`/);
                if (!satelliteRepoMatch) {
                  console.log('❌ Satellite repository not found in comment');
                  console.log('Comment body:', creationComment.body);
                  return null;
                }
                
                const satelliteIssueNumber = parseInt(satelliteIssueMatch[1]);
                const satelliteRepo = satelliteRepoMatch[1];
                
                console.log(`🔍 Found Satellite info: ${satelliteRepo}#${satelliteIssueNumber}`);
                
                return {
                  issueNumber: satelliteIssueNumber,
                  repo: satelliteRepo
                };
                
              } catch (error) {
                console.log(`❌ Error finding satellite info: ${error.message}`);
                return null;
              }
            }

            // Для событий комментариев проверяем, что комментарий в issue из Hub
            if (context.eventName === 'issue_comment') {
              const issueForComment = context.payload.issue;
              const isRouted = issueForComment.labels.some(label => label.name === 'state/routed');
              if (!isRouted) {
                console.log('ℹ️ Not a routed Hub issue comment, skipping sync');
                return;
              }
              
              // Пропускаем комментарии от ботов и системные комментарии
              if (comment.user.type === 'Bot' || 
                  comment.body.includes('🔄 Статус обновлен') ||
                  comment.body.includes('🏷️ Лейблы синхронизированы') ||
                  comment.body.includes('✅ Задача автоматически создана')) {
                console.log('ℹ️ Skipping bot or system comment');
                return;
              }
              
              // Ищем информацию о Satellite в комментариях
              const satelliteInfo = await findSatelliteInfo(issueForComment.number);
              if (!satelliteInfo) {
                console.log('❌ Satellite info not found in comments');
                return;
              }
              
              await syncCommentToSatellite(comment, issueForComment, satelliteInfo.issueNumber, satelliteInfo.repo);
              return;
            }
            
            // Проверяем что задача направлена в Satellite
            const isRouted = issue.labels.some(label => label.name === 'state/routed');
            if (!isRouted) {
              console.log('ℹ️ Not a routed Hub issue, skipping sync');
              return;
            }
            
            // Ищем информацию о Satellite в комментариях
            const satelliteInfo = await findSatelliteInfo(issue.number);
            if (!satelliteInfo) {
              console.log('❌ Satellite info not found in comments');
              return;
            }
            
            const satelliteIssueNumber = satelliteInfo.issueNumber;
            const satelliteRepo = satelliteInfo.repo;
            
            console.log(`🔧 Satellite repo: ${satelliteRepo}, Issue: #${satelliteIssueNumber}`);
            
            // Проверяем доступность PAT
            if (!process.env.SATELLITE_PAT) {
              console.log('❌ SATELLITE_PAT token is missing');
              return;
            }

            // Разбираем owner и repo из satelliteRepo
            const [satelliteOwner, satelliteRepoName] = satelliteRepo.split('/');
            if (!satelliteOwner || !satelliteRepoName) {
              console.log(`❌ Invalid satellite repo format: ${satelliteRepo}`);
              return;
            }

            console.log(`🔧 Satellite owner: ${satelliteOwner}, repo: ${satelliteRepoName}`);
            
            // Проверяем доступ к satellite репозиторию
            try {
              const testResponse = await fetch(
                `https://api.github.com/repos/${satelliteRepo}`,
                {
                  headers: {
                    'Authorization': `token ${process.env.SATELLITE_PAT}`,
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );
              
              if (!testResponse.ok) {
                console.log(`❌ Cannot access satellite repo ${satelliteRepo}: ${testResponse.status}`);
                return;
              }
              console.log(`✅ Satellite repo ${satelliteRepo} is accessible`);
            } catch (error) {
              console.log(`❌ Error accessing satellite repo: ${error.message}`);
              return;
            }
            
            // Определяем тип события для синхронизации лейблов
            if (context.eventName === 'issues' && (context.payload.action === 'labeled' || context.payload.action === 'unlabeled')) {
              await syncLabelsToSatellite(issue, satelliteIssueNumber, satelliteOwner, satelliteRepoName, label);
            }
            
            await syncStatusToSatellite(issue, satelliteIssueNumber, satelliteOwner, satelliteRepoName);
            
            async function syncStatusToSatellite(hubIssue, satelliteIssueNumber, satelliteOwner, satelliteRepo) {
              let status = '';
              let statusMessage = '';
              let shouldReopen = false;
              
              // Определяем статус на основе состояния и лейблов
              if (hubIssue.state === 'closed') {
                status = 'closed';
                statusMessage = '✅ Завершено в Hub';
              } else if (hubIssue.state === 'open') {
                // Если issue была переоткрыта (reopened)
                if (context.payload.action === 'reopened') {
                  status = 'open';
                  statusMessage = '🔄 Переоткрыто в Hub';
                  shouldReopen = true;
                } else {
                  // Проверяем наличие лейбла status/in-progress
                  const hasInProgressLabel = hubIssue.labels.some(label => label.name === 'status/in-progress');
                  if (hasInProgressLabel) {
                    status = 'status/in-progress';
                    statusMessage = '🔧 В работе';
                  } else {
                    status = 'open';
                    statusMessage = '📋 Открыто в Hub';
                  }
                }
              }
              
              if (!status) return;
              
              // Отправляем статус в Satellite
              await updateSatelliteStatus(satelliteIssueNumber, status, statusMessage, hubIssue, satelliteOwner, satelliteRepo, shouldReopen);
            }
            
            async function syncLabelsToSatellite(hubIssue, satelliteIssueNumber, satelliteOwner, satelliteRepo, changedLabel) {
              try {
                const syncPrefixes = ['status/', 'priority/', 'area/', 'type/'];
                const changedLabelName = changedLabel?.name;
                
                // Проверяем, относится ли измененный лейбл к синхронизируемым
                const shouldSync = syncPrefixes.some(prefix => changedLabelName?.startsWith(prefix));
                if (!shouldSync) {
                  console.log('ℹ️ Label not in sync scope: ' + changedLabelName);
                  return;
                }
                
                console.log('🔄 Syncing label to Satellite: ' + changedLabelName);
                
                // Получаем текущие лейблы hub issue
                const currentLabels = hubIssue.labels.map(l => l.name);
                
                // Фильтруем лейблы для синхронизации - берем ВСЕ лейблы с нужными префиксами
                const labelsToSync = currentLabels.filter(labelName => 
                  syncPrefixes.some(prefix => labelName.startsWith(prefix))
                );
                
                console.log('📋 All labels to sync from hub: ' + labelsToSync.join(', '));
                
                // Получаем текущие лейблы satellite issue используя PAT
                const satelliteIssueResponse = await fetch(
                  `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                  {
                    headers: {
                      'Authorization': `token ${process.env.SATELLITE_PAT}`,
                      'Accept': 'application/vnd.github.v3+json'
                    }
                  }
                );
                
                console.log(`🔧 Satellite API response status: ${satelliteIssueResponse.status}`);
                
                if (!satelliteIssueResponse.ok) {
                  const errorText = await satelliteIssueResponse.text();
                  console.log(`🔧 Satellite API error response: ${errorText}`);
                  throw new Error(`Failed to get satellite issue: ${satelliteIssueResponse.status} - ${errorText}`);
                }
                
                const satelliteIssue = await satelliteIssueResponse.json();
                const currentSatelliteLabels = satelliteIssue.labels.map(l => l.name);
                console.log('📋 Current satellite labels: ' + currentSatelliteLabels.join(', '));
                
                // Определяем какие лейблы нужно удалить из satellite
                const labelsToRemove = [];
                
                // Для каждого префикса находим текущий лейбл в satellite и сравниваем с hub
                for (const prefix of syncPrefixes) {
                  const hubLabelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                  const satelliteLabelForPrefix = currentSatelliteLabels.find(label => label.startsWith(prefix));
                  
                  // Если в satellite есть лейбл этого префикса, но в hub его нет или он другой - удаляем
                  if (satelliteLabelForPrefix && satelliteLabelForPrefix !== hubLabelForPrefix) {
                    labelsToRemove.push(satelliteLabelForPrefix);
                  }
                }
                
                console.log('🗑️ Labels to remove from satellite: ' + labelsToRemove.join(', '));
                
                // Удаляем старые лейблы из satellite
                for (const labelToRemove of labelsToRemove) {
                  const deleteResponse = await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/labels/${encodeURIComponent(labelToRemove)}`,
                    {
                      method: 'DELETE',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  
                  if (deleteResponse.ok) {
                    console.log('🗑️ Removed label from Satellite: ' + labelToRemove);
                  } else {
                    console.log('⚠️ Failed to remove label: ' + labelToRemove + ', status: ' + deleteResponse.status);
                  }
                }
                
                // Добавляем новые лейблы (только те, которых нет в satellite)
                const labelsToAdd = labelsToSync.filter(labelName => 
                  !currentSatelliteLabels.includes(labelName)
                );
                
                console.log('✅ Labels to add to satellite: ' + labelsToAdd.join(', '));

                if (labelsToAdd.length > 0) {
                  const addResponse = await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify(labelsToAdd)
                    }
                  );
                  
                  if (addResponse.ok) {
                    console.log('✅ Added labels to Satellite: ' + labelsToAdd.join(', '));
                  } else {
                    console.log('⚠️ Failed to add labels, status: ' + addResponse.status);
                  }
                }
                
                // Создаем комментарий о синхронизации лейблов
                if (labelsToRemove.length > 0 || labelsToAdd.length > 0) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/comments`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        body: '**🏷️ Лейблы синхронизированы из Hub**\n\n' +
                              '**Hub**: `' + context.repo.repo + '`\n' +
                              '**Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                              (labelsToAdd.length > 0 ? '**Добавлены**: `' + labelsToAdd.join('`, `') + '`\n' : '') +
                              (labelsToRemove.length > 0 ? '**Удалены**: `' + labelsToRemove.join('`, `') + '`\n' : '') +
                              '**Время**: ' + new Date().toLocaleString()
                      })
                    }
                  );
                }
                
                console.log(`✅ Synced labels to Satellite #${satelliteIssueNumber}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync labels to Satellite: ${error.message}`);
              }
            }

            async function syncCommentToSatellite(hubComment, hubIssue, satelliteIssueNumber, satelliteRepo) {
              try {
                console.log('💬 Syncing comment to Satellite');
                
                // Разбираем owner и repo из satelliteRepo
                const [satelliteOwner, satelliteRepoName] = satelliteRepo.split('/');
                if (!satelliteOwner || !satelliteRepoName) {
                  console.log(`❌ Invalid satellite repo format: ${satelliteRepo}`);
                  return;
                }
                
                const commentBody = '**💬 Комментарий из Hub**\n\n' +
                                    '**Hub**: `' + context.repo.repo + '`\n' +
                                    '**Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                                    '**Автор**: @' + hubComment.user.login + '\n' +
                                    '**Время**: ' + new Date(hubComment.created_at).toLocaleString() + '\n\n' +
                                    '---\n\n' +
                                    hubComment.body + '\n\n' +
                                    '---\n\n' +
                                    '*Комментарий синхронизирован автоматически*';
                
                const response = await fetch(
                  `https://api.github.com/repos/${satelliteOwner}/${satelliteRepoName}/issues/${satelliteIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.SATELLITE_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: commentBody
                    })
                  }
                );
                
                if (!response.ok) {
                  throw new Error(`Failed to create comment in satellite: ${response.status}`);
                }
                
                console.log(`✅ Synced comment to Satellite #${satelliteIssueNumber}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync comment to Satellite: ${error.message}`);
              }
            }
            
            async function updateSatelliteStatus(satelliteIssueNumber, status, statusMessage, hubIssue, satelliteOwner, satelliteRepo, shouldReopen = false) {
              try {
                // Обновляем комментарий в Satellite используя PAT
                await fetch(
                  `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.SATELLITE_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: '**🔄 Статус обновлен из Hub**\n\n' +
                            '**Hub**: `' + context.repo.repo + '`\n' +
                            '**Issue**: [#' + hubIssue.number + '](' + hubIssue.html_url + ')\n' +
                            '**Статус**: ' + statusMessage + '\n' +
                            '**Время**: ' + new Date().toLocaleString()
                    })
                  }
                );
                
                // Обновляем метки статуса в Satellite
                const statusLabels = {
                  'in-progress': 'status/in-progress'
                };
                
                const newStatusLabel = statusLabels[status];
                if (newStatusLabel) {
                  // Получаем текущие лейблы satellite issue
                  const satelliteIssueResponse = await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  
                  if (!satelliteIssueResponse.ok) {
                    throw new Error(`Failed to get satellite issue: ${satelliteIssueResponse.status}`);
                  }
                  
                  const satelliteIssue = await satelliteIssueResponse.json();
                  
                  // Удаляем старые статусные метки
                  const oldStatusLabels = satelliteIssue.labels
                    .filter(label => label.name.startsWith('status/') && label.name !== newStatusLabel)
                    .map(label => label.name);
                  
                  for (const oldLabel of oldStatusLabels) {
                    await fetch(
                      `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/labels/${encodeURIComponent(oldLabel)}`,
                      {
                        method: 'DELETE',
                        headers: {
                          'Authorization': `token ${process.env.SATELLITE_PAT}`,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      }
                    );
                  }
                  
                  // Добавляем новую статусную метку
                  await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify([newStatusLabel])
                    }
                  );
                }
                
                // Если задача завершена в Hub, закрываем в Satellite
                if (status === 'closed') {
                  await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'closed'
                      })
                    }
                  );
                }
                
                // Если задача переоткрыта в Hub, переоткрываем в Satellite
                if (shouldReopen) {
                  await fetch(
                    `https://api.github.com/repos/${satelliteOwner}/${satelliteRepo}/issues/${satelliteIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.SATELLITE_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'open'
                      })
                    }
                  );
                  console.log('🔓 Reopened issue in Satellite');
                }
                
                console.log(`✅ Synced status to Satellite #${satelliteIssueNumber}: ${status}`);
                
              } catch (error) {
                console.log(`❌ Failed to sync status to Satellite: ${error.message}`);
              }
            }
