name: ðŸš€ Create Redmine Issue from GitHub

on:
  issues:
    types: [labeled]

jobs:
  create-redmine-issue:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'state/to-redmine'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Redmine Issue
        uses: actions/github-script@v7
        env:
          REDMINE_API_KEY: ${{ secrets.REDMINE_API_KEY }}
          REDMINE_URL: ${{ secrets.REDMINE_URL }}
        with:
          script: |
            const { issue } = context.payload;
            
            console.log('ðŸ”„ Creating Redmine issue from GitHub issue #' + issue.number);
            
            const hasRedmineCreatedLabel = issue.labels.some(l => l.name === 'state/redmine-created');
            if (hasRedmineCreatedLabel) {
              console.log('â„¹ï¸ Redmine issue already created, skipping');
              return;
            }
            
            await createRedmineIssue(issue);
            
            async function createRedmineIssue(githubIssue) {
              try {
                const redmineData = {
                  issue: {
                    project_id: '${{ secrets.REDMINE_PROJECT_ID }}', // ID Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð² Redmine
                    tracker_id: '${{ secrets.REDMINE_TRACKER_ID }}', // ID Ñ‚Ð¸Ð¿Ð° Ð·Ð°Ð´Ð°Ñ‡Ð¸ (Ð±Ð°Ð³/Ñ„Ð¸Ñ‡Ð° Ð¸ Ñ‚.Ð´.)
                    subject: `[GitHub #${githubIssue.number}] ${githubIssue.title}`,
                    description: formatDescription(githubIssue),
                    priority_id: getPriorityId(githubIssue),
                    status_id: 20, // ÐÐ¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
                    assigned_to_id: '${{ secrets.REDMINE_ASSIGNED_ID }}',
                    custom_fields: getCustomFields(githubIssue)
                  }
                };
                
                console.log('ðŸ“¤ Sending to Redmine:', JSON.stringify(redmineData, null, 2));
                
                const response = await fetch(`${process.env.REDMINE_URL}/issues.json`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Redmine-API-Key': process.env.REDMINE_API_KEY
                  },
                  body: JSON.stringify(redmineData)
                });
                
                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`Redmine API error: ${response.status} - ${errorText}`);
                }
                
                const redmineIssue = await response.json();
                
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð² GitHub issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: `âœ… **Ð—Ð°Ð´Ð°Ñ‡Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð² Redmine**\n\n` +
                        `**Redmine Issue**: [#${redmineIssue.issue.id}](${process.env.REDMINE_URL}/issues/${redmineIssue.issue.id})\n` +
                        `**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: ${redmineIssue.issue.status.name}\n` +
                        `**Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°**: ${new Date().toLocaleString()}`
                });
                
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð»ÐµÐ¹Ð±Ð» Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  labels: ['state/redmine-created']
                });
                
                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ GitHub issue
                const updatedBody = githubIssue.body + `\n\n---\n\n` +
                  `## ðŸ”— Redmine Integration\n\n` +
                  `âœ… Ð—Ð°Ð´Ð°Ñ‡Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð² Redmine: [#${redmineIssue.issue.id}](${process.env.REDMINE_URL}/issues/${redmineIssue.issue.id})`;
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: updatedBody
                });
                
                console.log('âœ… Created Redmine issue #' + redmineIssue.issue.id);
                
              } catch (error) {
                console.log('âŒ Failed to create Redmine issue: ' + error.message);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: githubIssue.number,
                  body: `âŒ **ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² Redmine**\n\n` +
                        `\`\`\`\n${error.message}\n\`\`\``
                });
              }
            }
            
            function formatDescription(githubIssue) {
              return `h1. GitHub Issue #${githubIssue.number}
              
              *Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¸Ð· GitHub: ${githubIssue.html_url}*
              *ÐÐ²Ñ‚Ð¾Ñ€: ${githubIssue.user.login}*
              *Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°: ${new Date(githubIssue.created_at).toLocaleString()}*
              
              h2. ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
              
              ${githubIssue.body || 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚'}
              
              h2. ÐœÐµÑ‚ÐºÐ¸ GitHub
              
              ${githubIssue.labels.map(label => `* ${label.name}`).join('\n')}
